<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ETH Buy Tables</title>

<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<style>
body {
  font-family: Segoe UI, Tahoma, sans-serif;
  margin: 0;
  padding: 30px 20px;
  background: #eef2f7;
}

.container {
  max-width: 1050px;
  margin: auto;
  background: #fff;
  padding: 26px;
  border-radius: 14px;
}

/* ðŸ”§ CHART FIX */
#ethChartWrapper {
  width: 100%;
  height: 520px;
}

#ethChart {
  width: 100%;
  height: 100%;
}
</style>
</head>

<body>

<div class="container">

  <!-- âœ… CHART OUTSIDE TABLE -->
  <div id="ethChartWrapper">
    <div id="ethChart"></div>
  </div>

</div>

<script>
/* ================= CHART INIT ================= */
const chartContainer = document.getElementById('ethChart');

const chart = LightweightCharts.createChart(chartContainer, {
  layout: {
    background: { color: '#ffffff' },
    textColor: '#111827'
  },
  grid: {
    vertLines: { color: '#e5e7eb' },
    horzLines: { color: '#e5e7eb' }
  },
  rightPriceScale: {
    autoScale: true,
    scaleMargins: {
      top: 0.12,
      bottom: 0.12
    }
  },
  timeScale: {
    timeVisible: true,
    secondsVisible: false
  }
});

/* âœ… PROPER SERIES CREATION */
const candleSeries = chart.addCandlestickSeries({
  upColor: '#22c55e',
  downColor: '#ef4444',
  borderUpColor: '#22c55e',
  borderDownColor: '#ef4444',
  wickUpColor: '#22c55e',
  wickDownColor: '#ef4444'
});

/* ================= LOAD CANDLES ================= */
async function loadCandles() {
  const res = await fetch(
    'https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=15m&limit=200',
    { cache: 'no-store' }
  );

  const data = await res.json();

  const candles = data.map(c => ({
    time: c[0] / 1000,
    open: +c[1],
    high: +c[2],
    low: +c[3],
    close: +c[4]
  }));

  candleSeries.setData(candles);

  chart.timeScale().fitContent();
}

/* ================= BUY LIMIT LINES ================= */
let buyLines = [];

function drawBuyLimitLines(start, end, step, lastBuy) {
  buyLines.forEach(l => candleSeries.removePriceLine(l));
  buyLines = [];

  for (let p = end; p <= start; p += step) {
    if (p > lastBuy) continue;

    buyLines.push(
      candleSeries.createPriceLine({
        price: p,
        color: '#22c55e',
        lineWidth: 2,
        axisLabelVisible: true,
        title: 'Buy'
      })
    );
  }
}

/* ================= MARKET PRICE ================= */
let marketLine = null;

function drawMarketPriceLine(price) {
  if (marketLine) candleSeries.removePriceLine(marketLine);

  marketLine = candleSeries.createPriceLine({
    price,
    color: '#2563eb',
    lineWidth: 2,
    lineStyle: LightweightCharts.LineStyle.Dotted,
    axisLabelVisible: true,
    title: 'Market'
  });
}

/* ================= RESIZE FIX ================= */
function resizeChart() {
  chart.applyOptions({
    width: chartContainer.clientWidth,
    height: chartContainer.clientHeight
  });
}

window.addEventListener('resize', resizeChart);
setTimeout(resizeChart, 0);

/* ================= INIT ================= */
loadCandles();

// example demo
setTimeout(() => {
  drawMarketPriceLine(3030);
  drawBuyLimitLines(3200, 2600, 50, 2900);
}, 1500);
</script>

</body>
</html>
